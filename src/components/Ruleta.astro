---
import icon_frecha from "@/assets/images/ruleta/icon_flecha.png";
import ruleta from "@/assets/images/ruleta/ruletav3.webp";
import item1 from "@/assets/images/ruleta/item1.png";
import item2 from "@/assets/images/ruleta/vales.png";
import item3 from "@/assets/images/ruleta/artefactos.png";
import item4 from "@/assets/images/ruleta/bono_adicionales.png";
import item5 from "@/assets/images/ruleta/item4.png";
import item6 from "@/assets/images/ruleta/bono_adicionales.png";
import bg_mobile from "@/assets/images/banner_mobile.webp"
import bg_tablet from "@/assets/images/banner_tablet.webp"
import bg_desktop from "@/assets/images/banner_desktop.webp"
---

<button class="bg-red-500 text-white px-4 py-2 rounded cursor-pointer entry_ruleta hidden">Entra ruleta</button>
<section class="ruletaGanadora relative hidden" data-step="4">
  <picture class="w-full h-full absolute top-0 left-0 z-0">
    <source srcset={bg_desktop.src} media="(min-width: 1280px)">
    <source srcset={bg_tablet.src} media="(min-width: 768px)">
    <img class="w-full h-full object-cover" src={bg_mobile.src} alt="Â¡Gira la ruleta y gana premios al instante!">
  </picture>
  <div class="container relative z-1">
    <p data-aos="zoom-in-up">Â¡Felicitaciones! Tienes <b class="text_allow_user">1 oportunidad</b> para girar la ruleta</p>
    <h2 data-aos="zoom-in-up">Â¡Es hora de girar y ganar!</h2>
    <h4 data-aos="zoom-in-up">Haz clic en el botÃ³n de abajo y deja que la suerte decida tu premio.</h4>
    <button data-aos="zoom-in-up" class="cursor-pointer disabled:bg-gray-200 disabled:border-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed transition-all duration-300 z-50" id="btnGirar">Gira la ruleta</button>
    <div class="contentRuleta opacity-0 transition-opacity duration-300" data-aos="zoom-in-down" data-aos-delay="100">
      <img src={icon_frecha.src} alt="" class="flecha">
      <div class="size-10 bg-logo-claro-gradient isotipo_claro rounded-full p-[8px] absolute top-1/2 -translate-y-1/2 left-1/2 -translate-x-1/2 z-20">
        <svg class="w-full h-full relative bg-logo-claro-gradient rounded-full" width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M27.4407 22.1073L42.8203 7.00478L38.7367 3.04688L23.3572 18.1494L27.4407 22.1073Z" fill="white"/>
          <path d="M17.1317 0H11.6813V16.0108H17.1317V0Z" fill="white"/>
          <path d="M47.4938 28.207H30.3663V33.544H47.4938V28.207Z" fill="white"/>
          <path d="M18.1749 39.1204C16.854 40.5036 15.1633 41.1184 13.2085 41.1184C11.3065 41.1184 9.6686 40.4524 8.34776 39.1204C7.02691 37.7372 6.28724 36.1491 6.28724 34.3048C6.28724 32.3581 7.02691 30.77 8.34776 29.438C9.6686 28.0548 11.3593 27.4401 13.2085 27.4913C15.1633 27.4401 16.8012 28.1061 18.2277 29.438C19.4957 30.7188 20.1826 32.3581 20.2354 34.3048C20.1826 36.1491 19.4957 37.7372 18.1749 39.1204ZM22.6129 25.1347C19.9712 22.5733 16.8012 21.3438 13.2085 21.3438C9.61577 21.3438 6.49857 22.5733 3.90971 25.1347C1.26802 27.6962 0 30.77 0 34.3048C0 37.8397 1.26802 40.9647 3.90971 43.4237C6.44574 45.9852 9.56294 47.2659 13.2085 47.2659C16.8012 47.2659 19.9712 45.9852 22.6129 43.4237C25.2018 40.9135 26.4698 37.8397 26.4698 34.3048C26.4698 30.77 25.2018 27.6962 22.6129 25.1347Z" fill="white"/>
        </svg>
      </div>
      <!-- <img src={icon_claro.src} alt="" class="claro"> -->
      <div class="ruleta transition-opacity duration-300">
        <img src={ruleta.src} alt="" class="imgRuleta">
        <div class="ruleta-lights">
          <span class="ruleta-light ruleta-light-1"></span>
          <span class="ruleta-light ruleta-light-2"></span>
          <span class="ruleta-light ruleta-light-3"></span>
          <span class="ruleta-light ruleta-light-4"></span>
          <span class="ruleta-light ruleta-light-5"></span>
          <span class="ruleta-light ruleta-light-6"></span>
        </div>
        <div class="item item1" data-nombre="Accesorios"><img src={item1.src} alt=""></div>
        <div class="item item2" data-nombre="Vales general"><img src={item2.src} alt=""></div>
        <div class="item item3" data-nombre="Artefactos" data-stock="0"><img src={item3.src} alt=""></div>
        <div class="item item4" data-nombre="Bonos"><img src={item4.src} alt=""></div>
        <div class="item item5" data-nombre="Equipos"><img src={item5.src} alt=""></div>
        <div class="item item6" data-nombre="Bonos"><img src={item6.src} alt=""></div>
      </div>
    </div>
    <p class="legal">*ImÃ¡genes referenciales. Aplican cambios segÃºn disponibilidad de stock.</p>
  </div>
</section>

<style>
  .ruleta-lights {
    pointer-events: none;
    position: absolute;
    inset: 0;
    top: -30px;
    left: -26px;
    rotate: 6deg;
    @media (min-width: 768px){
      top: -50px;
      left: -40px;
    }
  }
  .ruleta-light {
    position: absolute;
    top: 50%;
    left: 50%;
    width: var(--ruleta-light-size);
    height: var(--ruleta-light-size);
    border-radius: 999px;
    opacity: 0.6;
    /* filter: blur(2px); */
    mix-blend-mode: soft-light;
    background: radial-gradient(circle, #ffe9b8 0%, #ffc35a 45%, #e78b25 100%);
    box-shadow: 0 0 10px rgba(255, 195, 90, 0.9), 0 0 18px rgba(255, 195, 90, 0.8);
    transform-origin: center center;
    transform: translate(-50%, -50%);
    --flash-scale: 1;
    animation: ruleta-light-flash 1.3s ease-in-out infinite alternate;
  }
  .ruleta-light-1 { transform: rotate(  0deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }
  .ruleta-light-2 { transform: rotate( 60deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }
  .ruleta-light-3 { transform: rotate(120deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }
  .ruleta-light-4 { transform: rotate(180deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }
  .ruleta-light-5 { transform: rotate(240deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }
  .ruleta-light-6 { transform: rotate(300deg) translate(var(--ruleta-radius)) translate(-50%, -50%) scale(var(--flash-scale)); }

  /* Escalonar el destello para que no todas las luces parpadeen al mismo tiempo */
  .ruleta-light-1 { animation-delay: 0s; }
  .ruleta-light-2 { animation-delay: 0.15s; }
  .ruleta-light-3 { animation-delay: 0.3s; }
  .ruleta-light-4 { animation-delay: 0.45s; }
  .ruleta-light-5 { animation-delay: 0.6s; }
  .ruleta-light-6 { animation-delay: 0.75s; }

  @keyframes ruleta-light-flash {
    0% {
      opacity: 0.35;
      --flash-scale: 0.85;
      box-shadow: 0 0 6px rgba(255, 195, 90, 0.5), 0 0 10px rgba(255, 195, 90, 0.4);
    }
    50% {
      opacity: 0.9;
      --flash-scale: 1.05;
      box-shadow: 0 0 14px rgba(255, 210, 120, 0.9), 0 0 20px rgba(255, 210, 120, 0.8);
    }
    100% {
      opacity: 0.6;
      --flash-scale: 1.15;
      box-shadow: 0 0 20px rgba(255, 230, 150, 1), 0 0 30px rgba(255, 230, 150, 0.9);
    }
  }
  section.ruletaGanadora {
    background-color: #000;
    p {
      color: #fff;
      text-align: center;
      font-family: "AMX Regular";
      font-size: 30px;
      font-style: normal;
      font-weight: 400;
      line-height: 100%;
      letter-spacing: 0.6px;

      b {
        font-family: AMX;
        font-weight: 700;
      }
    }

    h2 {
      color: #fff;
      font-family: AMX;
      font-size: 50px;
      font-style: normal;
      font-weight: 800;
      line-height: normal;
      text-align: center;
      margin-top: 7px;
    }

    h4 {
      display: block;
      color: #fff;
      text-align: center;
      font-family: AMX;
      font-size: 20px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
      margin-top: 10px;
    }

    button {
      color: #fff;
      text-align: center;
      font-family: AMX;
      font-size: 20px;
      font-style: normal;
      font-weight: 700;
      line-height: normal;
      border-radius: 110px;
      background: #da291c;
      width: 204px;
      height: 55px;
      border: none;
      margin: 0 auto;
      display: block;
      margin-top: 18px;

      &.disabled {
        opacity: 0.4;
        pointer-events: none;
      }
    }

    .contentRuleta {
      /* pointer-events: none; */
      position: relative;
      margin-bottom: 50px;

      .flecha {
        position: absolute;
        top: 3px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2;
      }

      .claro {
        position: absolute;
        top: 49.5%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2;
        width: 100px;
      }
    }

    .ruleta {
      margin: 0 auto;
      margin-top: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      max-width: 665px;
      --ruleta-radius: calc(50% + 162px); /* radio relativo al ancho del contenedor */
      --ruleta-light-size: 24px;
      .imgRuleta {
        width: 100%;
        max-width: 665px;
      }
      @media (min-width: 768px){
        --ruleta-radius: calc(50% + 290px);
        --ruleta-light-size: 36px;
      }
      @media (min-width: 1200px){
        --ruleta-light-size: 44px;
      }

      .item {
        position: absolute;

        &.item1 {
          top: 95px;
          left: 50%;
          transform: translateX(-50%);
          img {
            width: 106px;
          }
        }

        &.item2 {
          top: 158px;
          right: 120px;
          transform: rotate(60deg);

          img {
            width: 110px;
          }
        }

        &.item3 {
          bottom: 175px;
          right: 119px;
          transform: rotate(116deg);
          img {
            width: 100px;
          }
        }

        &.item4 {
          bottom: 90px;
          left: 50%;
          transform: translateX(-50%) rotate(-180deg);
          img {
            width: 100px;
          }
        }

        &.item5 {
          bottom: 166px;
          left: 130px;
          transform: rotate(238deg);

          img {
            width: 102px;
          }
        }

        &.item6 {
          top: 168px;
          left: 140px;
          transform: rotate(293deg);

          img {
            width: 100px;
          }
        }
      }
    }

    .legal {
      color: #fff;
      text-align: center;
      font-family: Roboto;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }
  }

  .modalPremio {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;

    &.active {
      display: flex;
    }

    .modalContent {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 80%;
      max-width: 350px;
      text-align: center;
    }
  }

  @media (max-width: 1280px) {
    section.ruletaGanadora p {
      font-size: 28px;
    }

    section.ruletaGanadora h2 {
      font-size: 46px;
    }

    section.ruletaGanadora span {
      font-size: 18px;
    }
  }

  @media (max-width: 900px) {
    section.ruletaGanadora p {
      font-size: 25px;
    }

    section.ruletaGanadora h2 {
      font-size: 42px;
    }

    section.ruletaGanadora span {
      font-size: 18px;
    }
  }

  @media (max-width: 740px) {
    section.ruletaGanadora .ruleta {
      max-width: 600px;
    }

    section.ruletaGanadora .contentRuleta .flecha {
      width: 80px;
    }

    section.ruletaGanadora .ruleta .item.item1 {
      top: 83px;
      left: 49.5%;
    }

    section.ruletaGanadora .ruleta .item.item1 img {
      width: 121px;
    }

    section.ruletaGanadora .ruleta .item.item2 img {
      width: 87px;
    }

    section.ruletaGanadora .ruleta .item.item2 {
      top: 200px;
      right: 122px;
      transform: rotate(67deg);
    }

    section.ruletaGanadora .ruleta .item.item3 {
      bottom: 135px;
      right: 96px;
      transform: rotate(123deg);
    }

    section.ruletaGanadora .ruleta .item.item3 img {
      width: 157px;
    }

    section.ruletaGanadora .ruleta .item.item4 {
      bottom: 93px;
      left: 49.5%;
      transform: translateX(-50%) rotate(-180deg);
    }

    section.ruletaGanadora .ruleta .item.item4 img {
      width: 88px;
    }

    section.ruletaGanadora .ruleta .item.item5 {
      bottom: 207px;
      left: 127px;
      transform: rotate(242deg);
    }

    section.ruletaGanadora .ruleta .item.item5 img {
      width: 87px;
    }

    section.ruletaGanadora .ruleta .item.item6 {
      top: 195px;
      left: 121px;
      transform: rotate(300deg);
    }

    section.ruletaGanadora .ruleta .item.item6 img {
      width: 85px;
    }
  }

  @media (max-width: 750px) {
    section.ruletaGanadora p {
      font-size: 20px;
    }

    section.ruletaGanadora h2 {
      font-size: 35px;
    }

    section.ruletaGanadora span {
      font-size: 16px;
    }

    section.ruletaGanadora button {
      font-size: 18px;
      width: 183px;
      height: 48px;
    }
  }

  @media (max-width: 660px) {
    section.ruletaGanadora .ruleta {
      max-width: 500px;
      margin-top: 30px;
    }

    section.ruletaGanadora .contentRuleta .flecha {
      width: 64px;
      top: 6px;
    }

    section.ruletaGanadora .ruleta .item.item1 {
      top: 79px;
    }

    section.ruletaGanadora .ruleta .item.item1 img {
      width: 96px;
    }

    section.ruletaGanadora .ruleta .item.item2 {
      top: 162px;
      right: 104px;
      transform: rotate(66deg);
    }

    section.ruletaGanadora .ruleta .item.item2 img {
      width: 77px;
    }

    section.ruletaGanadora .ruleta .item.item3 {
      bottom: 117px;
      right: 81px;
      transform: rotate(121deg);
    }

    section.ruletaGanadora .ruleta .item.item3 img {
      width: 129px;
    }

    section.ruletaGanadora .contentRuleta .claro {
      width: 74px;
    }

    section.ruletaGanadora .ruleta .item.item4 {
      bottom: 78px;
      left: 49.5%;
    }

    section.ruletaGanadora .ruleta .item.item4 img {
      width: 75px;
    }

    section.ruletaGanadora .ruleta .item.item5 {
      bottom: 174px;
      left: 106px;
    }

    section.ruletaGanadora .ruleta .item.item5 img {
      width: 75px;
    }

    section.ruletaGanadora .ruleta .item.item6 {
      top: 166px;
      left: 105px;
      transform: rotate(298deg);
    }

    section.ruletaGanadora .ruleta .item.item6 img {
      width: 75px;
    }
  }

  @media (max-width: 500px) {
    section.ruletaGanadora .ruleta {
      margin-top: 20px;
    }

    section.ruletaGanadora .contentRuleta {
      margin-bottom: 20px;
    }

    section.ruletaGanadora .ruleta {
      height: 400px;
    }

    section.ruletaGanadora .ruleta .imgRuleta {
      width: 363px;
      position: absolute;
      max-width: 363px;
    }

    section.ruletaGanadora .contentRuleta .flecha {
      width: 60px;
      top: 19px;
    }

    section.ruletaGanadora p {
      font-size: 16px;
    }

    section.ruletaGanadora h2 {
      font-size: 30px;
    }

    section.ruletaGanadora span {
      font-size: 14px;
    }

    section.ruletaGanadora button {
      font-size: 16px;
      width: 160px;
      height: 41px;
    }

    section.ruletaGanadora .legal {
      font-size: 12px;
    }

    section.ruletaGanadora .ruleta .item.item1 {
      top: 67px;
    }

    section.ruletaGanadora .ruleta .item.item1 img {
      width: 72px;
    }

    section.ruletaGanadora .ruleta .item.item2 {
      top: 100px;
      right: 46%;
      transform: translateX(171%) rotate(62deg);
    }

    section.ruletaGanadora .ruleta .item.item2 img {
      width: 60px;
    }

    section.ruletaGanadora .ruleta .item.item3 {
      bottom: 110px;
      right: 43%;
      transform: translateX(161%) rotate(121deg);
    }

    section.ruletaGanadora .ruleta .item.item3 img {
      width: 54px;
    }

    section.ruletaGanadora .ruleta .item.item4 {
      bottom: 98px;
      left: 49.5%;
    }

    section.ruletaGanadora .ruleta .item.item4 img {
      width: 60px;
    }

    section.ruletaGanadora .contentRuleta .claro {
      width: 56px;
    }

    section.ruletaGanadora .ruleta .item.item5 {
      top: 264px;
      left: 48%;
      transform: translateX(-200%) rotate(242deg);
    }

    section.ruletaGanadora .ruleta .item.item5 img {
      width: 70px;
    }

    section.ruletaGanadora .ruleta .item.item6 {
      top: 143px;
      left: 51%;
      transform: translateX(-196%) rotate(298deg);
    }

    section.ruletaGanadora .ruleta .item.item6 img {
      width: 57px;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import JustValidate from 'just-validate';
  import { togglePreloadAnimation } from "@/utils/animations";
  import {getListProducts, validUserEnabled, spinSaveResult} from '@/utils/endpoints';
  import { userStore } from '@/store/userStore';
  import { showCustomModal } from '@/utils/modalHelper';
  import icon_no_cumple from "@/assets/icons/icon_no_cumple.svg";
  import icon_gano_premio from "@/assets/icons/icon_gano_premio.svg";

  const userWinFake = {
    "success": true,
    "result": "WIN",
    "prizeId": "b0975216-cd8a-4761-b81b-83e33de8858c",
    "prizeName": "Descuento de Whopper Jr",
    "prizeImageUrl": "https://crm.dev-limprod.com/images/premios/c885731f-5d48-4447-98c2-212f07755a3e.png",
    "prizeTypeId": 3,
    "prizeTypeName": "Vales general",
    "probability": 0.50000,
    "remainingPlays": 1,
    "message": "Â¡Felicitaciones! Has ganado: Descuento de Whopper Jr"
}

  const btnGirar = document.querySelector("#btnGirar") as HTMLButtonElement;
  const ruletaTable = document.querySelector(".ruleta") as HTMLElement;
  const containerRuleta = document.querySelector(".contentRuleta") as HTMLElement;
  const items = document.querySelectorAll(".ruleta .item");

  let yaGiro = false;
  let gradosActuales = 0;

  const resetRulsete = () =>{
    document.querySelectorAll(".section_hidden").forEach(section => section.classList.remove("hidden"));
    document.querySelector(".ruletaGanadora").classList.add("hidden");
    document.querySelector(".main_ruleta").classList.add("overflow-hidden");
    document.querySelector("[data-step='3']").classList.add("hidden");
    document.querySelector("[data-step='2']").classList.remove("hidden");
    document.querySelector("[data-step='2']").classList.remove("hidden", "xl:hidden");
    yaGiro = false;
    resetForm();
  }

  const showRuleta = () =>{
    document.querySelectorAll(".section_hidden").forEach(section => section.classList.add("hidden"));
    document.querySelector(".ruletaGanadora").classList.remove("hidden");
  }

  function elegirIndiceGanador(cantidadItems: number): number {
    // AquÃ­ se puede reemplazar por una lÃ³gica de probabilidades con pesos
    return Math.floor(Math.random() * cantidadItems);
  }

  const showModalWin = (dataResponse, user) =>{
    showCustomModal({
      title:`Â¡Felicitaciones!`,
      html: `
        <p class="font-amx-regular text-xl xl:text-2xl">Ganaste un: <span class="font-amx-bold">${dataResponse?.prizeName}</span></p>
        <img class="max-w-[250px] mx-auto" src="${dataResponse?.prizeImageUrl}" alt="${dataResponse?.prizeName}"/>
        <p>Te contactaremos por correo en los prÃ³ximos dÃ­as para coordinar la entrega.</p>
      `,
      iconSrc: icon_gano_premio.src,
      confirmButtonText: "Volver al inicio",
      showCloseButton: true,
      onConfirm: () => {
        resetRulsete();
        resetForm();
      },
    });
  }

  function girarRuleta() {
    const { user  } = userStore.getState();
    if (yaGiro) return;
    yaGiro = true;

    btnGirar.disabled = true;

    // Filtrar solo los Ã­tems con stock > 0
    const itemsDisponibles: { index: number; element: Element }[] = [];
    items.forEach((item, index) => {
      const stockAttr = item.getAttribute("data-stock");
      const stock = stockAttr ? Number(stockAttr) : 0;
      if (stock > 0) {
        itemsDisponibles.push({ index, element: item });
      }
    });

    // Si no hay Ã­tems disponibles, cancelamos el giro y reactivamos el botÃ³n
    if (itemsDisponibles.length === 0) {
      console.warn("No hay Ã­tems disponibles con stock > 0 para girar la ruleta.");
      yaGiro = false;
      btnGirar.disabled = true;
      return;
    }

    const cantidadItemsDisponibles = itemsDisponibles.length;
    const gradosPorItem = 318 / items.length;

    // Elegimos un Ã­ndice ganador solo entre los Ã­tems con stock disponible
    const indiceArray = elegirIndiceGanador(cantidadItemsDisponibles);
    const indiceGanador = itemsDisponibles[indiceArray].index;

    const vueltasExtras = 360 * 4;
    const offsetFlecha = 5;
    const anguloObjetivo = 360 - gradosPorItem * indiceGanador - gradosPorItem / 2 + offsetFlecha;
    const anguloFinal = gradosActuales + vueltasExtras + anguloObjetivo;

    const itemGanador = items[indiceGanador];

    gsap.to(ruletaTable, {
      rotation: anguloFinal,
      duration: 8.5,
      ease: "power3.out",
      onComplete: async () => {
        togglePreloadAnimation(true);
        const category_id = itemGanador.getAttribute("data-category_id");
        //console.log("CategorÃ­a Ganador:", category_id);
        // DespuÃ©s del giro mostrar modal
        btnGirar.disabled = false;
        try {
          const spinSaveResultResponse = await spinSaveResult(user.serviceId, Number(category_id));
          //console.log({ spinSaveResultResponse });
          if (spinSaveResultResponse?.result === 'WIN') {
            showModalWin(spinSaveResultResponse, user);
          }else{
            showCustomModal({
              title:`ðŸŽ ${spinSaveResultResponse.message}`,
              iconSrc: icon_no_cumple.src,
              confirmButtonText: "Volver al inicio",
              showCloseButton: false,
              onConfirm: () => {
                resetRulsete();
              },
            });
          }
        } catch (error) {
          console.error('Error en spinSaveResult:', error);
          throw error;
        }finally{
          togglePreloadAnimation(false);
        }
      },
    });

    gradosActuales = anguloFinal;
  }

  const eventInitRuleta = new CustomEvent("ruleta:enter");
  const entry_btn = document.querySelector(".entry_ruleta");
  entry_btn.addEventListener("click", () => {
    const sinVale = '4e2f787c-6391-467b-894e-d3340e35582e'
    const conVale = '178ce82c-618d-4f7f-8ec2-2e51ae9abeb1'
    const userTemp = {
      "id": "e315e242-b2cd-48cb-b606-5a4188ef5aa6",
      "email": "javiercastro.ik@gmail.com",
      "fullName": "Victor Castro",
      "docType": "DNI",
      "docNumber": "42122122",
      "serviceId": "d999f49b-a8cf-46c0-904f-093d6dd9f9ab",
      "provinceId": sinVale
    }
    userStore.setState({ user: userTemp });
    // document.dispatchEvent(eventInitRuleta);
    showModalWin(userWinFake, userTemp);
    // containerRuleta.classList.remove("opacity-0");
    // showRuleta();
    //console.log(userStore.getState());
  });

  const resetForm = () => {
    const form = document.querySelector('#form-registro') as HTMLFormElement;
    const submitBtn = document.querySelector('#btn-submit-form') as HTMLButtonElement;
    const fieldName = document.querySelector('#name') as HTMLInputElement;
    const fieldEmail = document.querySelector('#email') as HTMLInputElement;
    const fieldDni = document.querySelector('#dni') as HTMLInputElement;
    const fieldPhone = document.querySelector('#phone') as HTMLSelectElement;
    const validator = new JustValidate('#form-registro');
    form.reset();
    validator.refresh();
    fieldPhone.disabled = true;
    fieldName.disabled = true;
    fieldEmail.disabled = true;
    fieldDni.disabled = true;
    submitBtn.disabled = true;
  };
  
  
  document.addEventListener("ruleta:enter", async () => {
    const { user  } = userStore.getState();
    try {
      const userEnabledResponse = await validUserEnabled(user.serviceId);
      const { canSpin, remainingPlays, playsAllowed, playsUsed, reason } = userEnabledResponse || {};
      const mainRuleta = document.querySelector(".main_ruleta");
      showRuleta();
      if (window.innerWidth >= 1200){
        mainRuleta.classList.remove("overflow-hidden");
      }else{
        // mainRuleta.classList.add("h-full");
      }
      //BotÃ³n para animacion de entrada de ruleta
      const isotipoWrapper = document.querySelector(".isotipo_claro");
      const isotipo = isotipoWrapper?.querySelector("svg");
      // Animar el isotipo cuando se hace clic en el botÃ³n de entrada
      const forseCanSpin = true;
      if (canSpin) {
        const listProductsResponse = await getListProducts(user.provinceId);
        const dataProducts = listProductsResponse.data;
        const totalStockProducts = listProductsResponse.count;
        //console.log({listProductsResponse, totalStockProducts})
        if (listProductsResponse.length === 0) {
          showCustomModal({
            title: "Lo sentimos, no puedes participar en estos momentos ðŸ‘‡",
            html: `<p>No hay premios disponibles para girar la ruleta.</p>`,
            iconSrc: icon_no_cumple.src,
            confirmButtonText: "Volver al inicio",
            showCloseButton: false,
            onConfirm: () => {
              resetRulsete();
            },
          });
          return;
        }
        if (totalStockProducts === 0) {
          showCustomModal({
            title: "Lo sentimos, no puedes participar en estos momentos ðŸ‘‡",
            html: `<p>No hay premios disponibles para girar la ruleta.</p>`,
            iconSrc: icon_no_cumple.src,
            confirmButtonText: "Volver al inicio",
            showCloseButton: false,
            onConfirm: () => {
              resetRulsete();
            },
          });
          return;
        }
        // console.log({dataProducts})
        const bonosResponse = dataProducts.filter(product => product.prizeTypeName === "Bonos");
        const accesoriosResponse = dataProducts.filter(product => product.prizeTypeName === "Accesorios");
        const valesResponse = dataProducts.filter(product => product.prizeTypeName === "Vales general");
        //console.log({valesResponse})
        const equiposResponse = dataProducts.filter(product => product.prizeTypeName === "Equipos");
        const artefactosResponse = dataProducts.filter(product => product.prizeTypeName === "Artefactos");
        items.forEach((item, index) => {
          const nombre = item.getAttribute("data-nombre");
          if (nombre === "Accesorios") {
            item.setAttribute("data-nombre", accesoriosResponse[0].prizeTypeName);
            item.setAttribute("data-stock", accesoriosResponse[0].hasStock);
            item.setAttribute("data-category_id", accesoriosResponse[0].prizeTypeId);
            item.querySelector("img").src = accesoriosResponse[0].imageUrl;
          }
          if (nombre === "Bonos") {
            item.setAttribute("data-nombre", bonosResponse[0].prizeTypeName);
            item.setAttribute("data-stock", bonosResponse[0].hasStock);
            item.setAttribute("data-category_id", bonosResponse[0].prizeTypeId);
            item.querySelector("img").src = bonosResponse[0].imageUrl;
          }
          if (nombre === "Equipos") {
            item.setAttribute("data-nombre", equiposResponse[0].prizeTypeName);
            item.setAttribute("data-stock", equiposResponse[0].hasStock);
            item.setAttribute("data-category_id", equiposResponse[0].prizeTypeId);
            item.querySelector("img").src = equiposResponse[0].imageUrl;
          }
          if (nombre === "Vales general") {
            if (valesResponse.length !== 0) {
              item.setAttribute("data-nombre", valesResponse[0].prizeTypeName);
              item.setAttribute("data-stock", valesResponse[0].hasStock);
              item.setAttribute("data-category_id", valesResponse[0].prizeTypeId);
              item.querySelector("img").src = valesResponse[0].imageUrl;
            }else{
              item.setAttribute("data-nombre", bonosResponse[0].prizeTypeName);
              item.setAttribute("data-stock", bonosResponse[0].hasStock);
              item.setAttribute("data-category_id", bonosResponse[0].prizeTypeId);
              item.querySelector("img").src = bonosResponse[0].imageUrl;
            }
          }
          if (nombre === "Artefactos") {
            if (artefactosResponse.length !== 0) {
              item.setAttribute("data-nombre", artefactosResponse[0].prizeTypeName);
              item.setAttribute("data-stock", artefactosResponse[0].hasStock);
              item.setAttribute("data-category_id", artefactosResponse[0].prizeTypeId);
              item.querySelector("img").src = artefactosResponse[0].imageUrl;
            }
          }
        });
        const rotacion = gsap.to(isotipo, {
          rotation: "+=360",
          repeat: -1,
          ease: "linear",
          duration: 0.3,
          opacity: 0,
        });
        containerRuleta.classList.remove("opacity-0");
        const ruletaIntro = gsap.to(ruletaTable, {
          rotation: "+=" + 360 * 50,
          duration: 1.5,
          ease: "power3.out",
        });
        
        gsap.from(isotipo, {
          scale: 600,
          transformOrigin: "50% 50%",
          duration: 1,
          opacity: 1,
          ease: "power3.out",
          onComplete: () => {
            rotacion.kill();
            gsap.set(isotipo, { rotation: 0 });
            isotipo.classList.remove("bg-logo-claro-gradient", "rounded-full");
            mainRuleta.classList.add("overflow-hidden");
            mainRuleta.classList.remove("h-full");
          },
        });
        btnGirar.addEventListener("click", girarRuleta);
      }else{
        showCustomModal({
          title: "Lo sentimos, no puedes participar en estos momentos ðŸ‘‡",
          html: `<p>${reason}</p>`,
          iconSrc: icon_no_cumple.src,
          confirmButtonText: "Entendido",
          showCloseButton: false,
          onConfirm: () => {
            resetRulsete();
          },
        });
      }
    } catch (error) {
      console.error(error);
    }finally{
      togglePreloadAnimation(false);
    }
  });  
</script>

</script>
