---
import Button from "@UI/Button.astro";
import iconTooltip from "@/assets/icons/tooltip.svg?raw";
---

<div
  class="w-full h-full relative z-10 xl:grid xl:grid-cols-2 items-start"
  data-step="2"
>
  <div
    class="flex flex-col items-center justify-center py-6 md:py-8 w-full relative xl:top-4 2xl:-right-13"
  >
    <h1
      data-aos="zoom-in-right"
      class="font-amx-regular text-xl md:text-3xl xl:text-2xl 2xl:text-3xl leading-none italic xl:leading-[0.5] text-center text-claro uppercase"
    >
      <strong
        class="block leading-none font-amx-black text-2xl md:text-4xl xl:text-3xl 2xl:text-5xl"
        >¬°Gira la Ruleta Ganadora!</strong
      >
    </h1>
    <p
      data-aos="zoom-in-right"
      class="font-amx-medium text-black text-[11px] md:text-base xl:text-[15px] 2xl:text-base text-balance py-2 md:py-3 px-3 text-center leading-none md:max-w-[570px] mx-auto"
    >
      Contrata un servicio M√≥vil o Internet Hogar.
    </p>
    <p
      data-aos="zoom-in-right"
      data-aos-delay="50"
      class="font-amx-bold italic text-[11px] md:text-[12px] text-center bg-claro text-white leading-none rounded-full px-2 md:px-3 py-1.5 md:py-2 pPremios"
    >
      ¬°JUEGA POR GIGAS, ACCESORIOS, EQUIPOS y muchos PREMIOS M√ÅS SEG√öN TU PLAN!
    </p>
  </div>
  <form
    id="form-registro"
    data-aos="zoom-in-up"
    class="bg-white px-4 md:px-10 xl:px-7 2xl:px-10 mt-40 lg:mt-62 xl:mt-0 py-8 2xl:py-10 w-full rounded-2xl font-roboto flex flex-col gap-3 md:gap-4 md:max-w-[500px] xl:max-w-[430px] 2xl:max-w-[540px] mx-auto relative xl:-top-7 xl:right-12 2xl:right-4 z-10 shadow-xl/20"
    action=""
  >
    <h3
      class="text-center font-amx-bold text-xl md:text-3xl xl:text-[26px] 2xl:text-[26px] leading-none"
    >
      Solicita recibir publicidad de Claro para participar:
    </h3>
    <fieldset class="grid grid-cols-2 gap-4">
      <div class="flex flex-col text-black">
        <label for="typeDoc" class="text-xs md:text-sm font-bold"
          >Tipo de documento</label
        >
        <div class="grid grid-cols-1 text-black">
          <select
            id="typeDoc"
            name="typeDoc"
            autocomplete="type-document-name"
            class="col-start-1 row-start-1 appearance-none w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none h-[40px]"
            required
          >
            <option value="" selected>Tipo de doc.</option>
            <option value="DNI">DNI</option>
            <option value="PASAPORTE">Pasaporte</option>
            <option value="CEX">Carn√© de extranjer√≠a</option>
          </select>
          <svg
            viewBox="0 0 16 16"
            fill="currentColor"
            data-slot="icon"
            aria-hidden="true"
            class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-900 sm:size-4 z-1"
          >
            <path
              d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"
              clip-rule="evenodd"
              fill-rule="evenodd"></path>
          </svg>
        </div>
      </div>
      <div class="flex flex-col text-black">
        <label for="dni" class="text-xs md:text-sm font-bold"
          >N√∫mero de documento</label
        >
        <input
          type="text"
          name="dni"
          id="dni"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none"
          placeholder="N√∫mero de documento"
          required
          disabled
        />
      </div>
    </fieldset>
    <fieldset>
      <label for="name" class="text-xs md:text-sm font-bold"
        >Nombres y Apellidos</label
      >
      <input
        type="text"
        name="name"
        id="name"
        inputmode="text"
        minlength="4"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none"
        placeholder="Nombres y apellidos"
        required
        disabled
      />
    </fieldset>
    <fieldset class="grid grid-cols-2 gap-4">
      <div class="flex flex-col text-black">
        <label for="departament" class="text-xs md:text-sm font-bold"
          >Departamento</label
        >
        <div class="grid grid-cols-1 text-black">
          <select
            id="departament"
            name="departament"
            autocomplete="type-document-name"
            class="col-start-1 row-start-1 appearance-none w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none h-[40px]"
            required
            disabled
          >
            <option value="" selected>Departamento</option>
          </select>
          <svg
            viewBox="0 0 16 16"
            fill="currentColor"
            data-slot="icon"
            aria-hidden="true"
            class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-900 sm:size-4 z-1"
          >
            <path
              d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"
              clip-rule="evenodd"
              fill-rule="evenodd"></path>
          </svg>
        </div>
      </div>
      <div class="flex flex-col text-black">
        <label for="province" class="text-xs md:text-sm font-bold"
          >Provincia</label
        >
        <div class="grid grid-cols-1 text-black">
          <select
            id="province"
            name="province"
            autocomplete="type-document-name"
            class="col-start-1 row-start-1 appearance-none w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none h-[40px]"
            required
            disabled
          >
            <option value="" selected>Provincia</option>
          </select>
          <svg
            viewBox="0 0 16 16"
            fill="currentColor"
            data-slot="icon"
            aria-hidden="true"
            class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-900 sm:size-4 z-1"
          >
            <path
              d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"
              clip-rule="evenodd"
              fill-rule="evenodd"></path>
          </svg>
        </div>
      </div>
    </fieldset>
    <fieldset>
      <label for="phone" class="text-xs md:text-sm font-bold"
        >Servicio asociado</label
      >
      <div class="grid grid-cols-1 text-black">
        <select
          id="phone"
          name="phone"
          autocomplete="phone-name"
          class="col-start-1 row-start-1 appearance-none w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none h-[40px] disabled:text-gray-500"
          required
          disabled
        >
          <option value="" selected>Selecciona tu servicio</option>
        </select>
        <svg
          viewBox="0 0 16 16"
          fill="currentColor"
          data-slot="icon"
          aria-hidden="true"
          class="pointer-events-none col-start-1 row-start-1 mr-2 size-5 self-center justify-self-end text-gray-900 sm:size-4 z-1"
        >
          <path
            d="M4.22 6.22a.75.75 0 0 1 1.06 0L8 8.94l2.72-2.72a.75.75 0 1 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L4.22 7.28a.75.75 0 0 1 0-1.06Z"
            clip-rule="evenodd"
            fill-rule="evenodd"></path>
        </svg>
      </div>
    </fieldset>
    <fieldset class="inputCasual" style="display: none;">
      <label for="phone" class="text-xs md:text-sm font-bold"
        >Ingresa el n√∫mero m√≥vil de contacto</label
      >
      <input
        type="text"
        name="telefono"
        id="telefono"
        maxlength="9"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none"
        placeholder="Ingrese su n√∫mero de tel√©fono"
        required
        disabled
      />
    </fieldset>
    <fieldset>
      <label
        for="email"
        class="text-xs md:text-sm font-bold flex gap-1 items-center"
      >
        Correo electr√≥nico
        <span
          class="cursor-pointer trigger relative block"
          data-tooltip="Recibir√°s la notificaci√≥n de tu premio en este correo."
        >
          <Fragment set:html={iconTooltip} />
        </span>
      </label>
      <input
        type="email"
        name="email"
        id="email"
        inputmode="email"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none"
        placeholder="Ingrese correo electr√≥nico"
        required
        disabled
      />
      <div id="email-errors"></div>
    </fieldset>

    <fieldset>
      <label
        for="email"
        class="text-xs md:text-sm font-bold flex gap-1 items-center"
      >
        Confirma o cambia tu correo electr√≥nico
        <span
          class="cursor-pointer trigger relative block"
          data-tooltip="Recibir√°s la notificaci√≥n de tu premio en este correo."
        >
          <Fragment set:html={iconTooltip} />
        </span>
      </label>
      <input
        type="email"
        name="emaildos"
        id="emaildos"
        inputmode="email"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg placeholder:text-[#75787C] text-black text-[15px] focus:outline-none"
        placeholder="Valida o actualiza tu correo electr√≥nico"
        required
        disabled
      />
      <div class="indicacion">
        *Puedes confirmar este correo o ingresar otro que est√©s usando
        actualmente.
      </div>
      <div id="email-errors"></div>
    </fieldset>
    <fieldset class="flex flex-col gap-1.5">
      <div class="flex flex-wrap items-center space-x-2">
        <label class="flex items-center space-x-2">
          <input
            type="checkbox"
            name="terms"
            id="terms"
            class="accent-claro"
            required
          />
          <div class="text-xs md:text-sm 2xl:text-base text-gray-900">
            Acepto los
          </div>
        </label>
        <strong
          class="text-xs md:text-sm 2xl:text-base text-gray-900 underline cursor-pointer openModalTratamiento"
          >t√©rminos y condiciones</strong
        >
      </div>
      <div class="flex flex-wrap items-center space-x-2">
        <label class="flex items-center space-x-2">
          <input
            type="checkbox"
            name="comunicacion"
            id="comunicacion"
            class="accent-claro"
          />
          <div class="text-xs md:text-sm 2xl:text-base text-gray-900">
            Solicito recibir
          </div>
        </label>
        <strong
          class="text-xs md:text-sm 2xl:text-base text-gray-900 underline cursor-pointer openModalPromociones"
          >publicidad de Claro.</strong
        >
      </div>
    </fieldset>
    <Button
      id="btn-submit-form"
      data-next-step="3"
      type="submit"
      disabled
      href="https://www.claro.com.pe/personas/app/claro-musica/"
      classes="min-w-fit px-12 py-2.5 xl:py-3.5 border border-claro cursor-pointer bg-claro hover:bg-claro-dark text-white hover:text-white disabled:bg-gray-200 disabled:border-gray-200 disabled:text-gray-400 disabled:cursor-not-allowed mx-auto"
      >Continuar</Button
    >
  </form>
  <div class="col-span-2 pt-3 xl:pt-0 xl:-mt-2">
    <p
      class="text-[11px] text-white text-center xl:text-left leading-none mx-auto xl:mr-0 xl:ml-auto md:max-w-[500px] xl:max-w-[430px] 2xl:max-w-[520px] relative xl:right-20 2xl:right-32 2xl:px-0"
    >
      No aplica para RUC 20 ni l√≠neas corporativas. Vale del 01/01/26 al
      20/01/26 y/o hasta agotar stock. Stock de premios: 1536033. Max. 1 premio
      por l√≠nea o play Claro Hogar. Premio de celulares no disponible para
      prepago. Tambi√©n participan clientes actuales que realicen las operaciones
      de la promoci√≥n. Tipos de premios seg√∫n plan y restricciones en secci√≥n
      "Nos gusta hablar claro"
    </p>
  </div>
</div>

<style>
  @media (max-width: 1599px) {
    .pPremios {
      max-width: 390px;
      margin: 0 20px;
    }
  }
  .indicacion {
    color: #75787c;
    font-size: 11px;
    font-style: italic;
    font-weight: 500;
    line-height: normal;
    margin-top: 5px;
  }
</style>

<script>
  import JustValidate from "just-validate";
  import { autoSuggestEmail } from "@/utils/autosuggestEmail";
  import icon_no_cumple from "@/assets/icons/icon_no_cumple.svg";
  import { showCustomModal } from "@/utils/modalHelper";
  import {
    preCheck,
    registerUser,
    validUserEnabled,
    verifyCode,
    getDepartament,
    getProvince,
    deleteUserByDni,
  } from "@/utils/endpoints";
  import { userStore } from "@/store/userStore";
  import { togglePreloadAnimation } from "@/utils/animations";

  document.addEventListener("DOMContentLoaded", async () => {
    const form = document.querySelector("#form-registro") as HTMLFormElement;
    const submitBtn = document.querySelector(
      "#btn-submit-form"
    ) as HTMLButtonElement;
    const fieldName = document.querySelector("#name") as HTMLInputElement;
    const fieldEmail = document.querySelector("#email") as HTMLInputElement;
    const fieldDni = document.querySelector("#dni") as HTMLInputElement;
    const fieldPhone = document.querySelector("#phone") as HTMLSelectElement;
    const inputCasual = document.querySelector(".inputCasual") as HTMLElement;
    const inputTelefono = document.querySelector(
      "#telefono"
    ) as HTMLInputElement;
    const fieldTypeDoc = document.querySelector("#typeDoc") as HTMLInputElement;
    const fieldDepartament = document.querySelector(
      "#departament"
    ) as HTMLSelectElement;
    const fieldProvince = document.querySelector(
      "#province"
    ) as HTMLSelectElement;
    const inputcorreo2 = document.querySelector("#emaildos") as HTMLInputElement;

    let realDniValue = "";
    let realNameValue = "";
    let realEmailValue = "";
    let realEmail2Value = "";

    let originalEmailLocalLength = 0;
    let emailWasPrefilled = false;

    const maskDni = (value: string) => {
      if (value.length <= 2) return value;
      return "*".repeat(value.length - 2) + value.slice(-2);
    };

    const maskName = (value: string) => {
      return value
        .split(" ")
        .map((word) => {
          if (word.length <= 3) return word;

          const first = word.slice(0, 2);
          const last = word.slice(-1);
          const masked = "*".repeat(word.length - 3);

          return `${first}${masked}${last}`;
        })
        .join(" ");
    };

    const maskEmail = (value: string) => {
      if (!value.includes("@")) return value;

      const [local, domain] = value.split("@");

      // üîê Si vino del backend y a√∫n hay contenido ‚Üí mantener m√°scara
      const maskLength = emailWasPrefilled
        ? Math.max(originalEmailLocalLength, local.length)
        : local.length;

      if (maskLength <= 2) {
        return `${local}@${domain}`;
      }

      const first = local[0] || "";
      const last = local[local.length - 1] || "";

      const masked = "*".repeat(maskLength - 2);

      return `${first}${masked}${last}@${domain}`;
    };

    const handleModal = (
      btnsOpenSelector,
      modalsSelector,
      closesSubSelector,
      closesBtnSelector
    ) => {
      const modals = document.querySelectorAll(modalsSelector);
      const btnsOpen = document.querySelectorAll(btnsOpenSelector);
      const closesSub = document.querySelectorAll(closesSubSelector);
      const closesBtn = document.querySelectorAll(closesBtnSelector);

      btnsOpen.forEach((btn, i) => {
        btn.onclick = () => {
          modals[i].classList.add("active");
          //console.log("CLICK");
          window.onclick = (event) => {
            if (event.target === modals[i]) {
              modals.forEach((modal) => modal.classList.remove("active"));
            }
          };
        };
      });

      closesSub.forEach((close) => {
        close.onclick = () => {
          modals.forEach((modal) => modal.classList.remove("active"));
        };
      });

      closesBtn.forEach((close) => {
        close.onclick = () => {
          modals.forEach((modal) => modal.classList.remove("active"));
        };
      });
    };

    const checkIfPhoneOptionHasPlus = () => {
      if (!fieldPhone) return false;

      const selectedOption = fieldPhone.options[fieldPhone.selectedIndex];
      if (!selectedOption) return false;

      // Verificar si el texto de la opci√≥n contiene "+"
      return (
        selectedOption.textContent?.includes("Fija") ||
        selectedOption.textContent?.includes("fija") ||
        selectedOption.textContent?.includes("Play") ||
        selectedOption.textContent?.includes("play") ||
        false
      );
    };

    const handlePhoneChange = () => {
      const hasPlus = checkIfPhoneOptionHasPlus();

      if (hasPlus) {
        // Mostrar el campo y habilitar el input
        inputCasual.style.display = "block";
        inputTelefono.disabled = false;
        inputTelefono.required = true;

        // Si el validador existe, agregar validaci√≥n para el tel√©fono
        if (validator) {
          validator.addField("#telefono", [
            {
              rule: "required",
              errorMessage: "*Ingresa el n√∫mero de tel√©fono.",
            },
            {
              rule: "minLength",
              value: 9,
              errorMessage: "El tel√©fono debe tener 9 d√≠gitos.",
            },
            {
              rule: "maxLength",
              value: 9,
              errorMessage: "El tel√©fono debe tener 9 d√≠gitos.",
            },
            {
              validator: (value) => /^\d+$/.test(value),
              errorMessage: "Solo se permiten n√∫meros.",
            },
          ]);

          // Revalidar el campo tel√©fono
          validator.revalidateField("#telefono");
        }
      } else {
        // Ocultar el campo y deshabilitar el input
        inputCasual.style.display = "none";
        inputTelefono.disabled = true;
        inputTelefono.required = false;
        inputTelefono.value = ""; // Limpiar el valor

        // Si el validador existe, remover la validaci√≥n del tel√©fono
        if (validator) {
          validator.removeField("#telefono");
        }
      }

      // Revalidar todos los campos para actualizar el estado del bot√≥n submit
      if (validator) {
        validator.revalidate();
      }
    };

    // Agregar evento change al select de servicio
    if (fieldPhone) {
      fieldPhone.addEventListener("change", handlePhoneChange);
    }

    // Restricciones de entrada en los campos
    const restrictInput = (selector, allowedRegex) => {
      const element = document.querySelector(
        selector
      ) as HTMLInputElement | null;
      if (!element) return;

      // Si ya existe un handler previo, lo removemos para no acumular listeners
      const anyElement = element as any;
      if (anyElement._restrictHandler) {
        element.removeEventListener("input", anyElement._restrictHandler);
      }

      const handler = (event: Event) => {
        const input = event.target as HTMLInputElement;
        input.value = input.value.replace(allowedRegex, "");
      };

      element.addEventListener("input", handler);
      anyElement._restrictHandler = handler;
    };

    const errorFindUser = (message = "") => {
      togglePreloadAnimation(false);
      //console.log({message})
      const messageDefault =
        '<p class="mensajeModal"><b>Ent√©rate c√≥mo participar <span class="btnOpenModal2">aqu√≠</span>.</b><br> <strong>*Si cumples con las condiciones tu participaci√≥n se habilitar√° en un m√°ximo de 72h.</strong></p>';
      const messageShow =
        message === "Ya est√°s registrado y verificado."
          ? `<p>${message}</p>`
          : messageDefault;
      showCustomModal({
        iconSrc: icon_no_cumple.src,
        title: "Lo sentimos, no puedes participar en estos momentos üëá",
        html: messageShow,
        confirmButtonText: "Entendido",
        showCloseButton: true,
        onConfirm: () => {
          // aqu√≠ haces el callback que quieras, por ejemplo:
          resetForm();
        },
      });
    };

    const setValuesForm = (user) => {
      realNameValue = user.fullName;
      fieldName.value = maskName(realNameValue);
      fieldName.disabled = false;
      realEmailValue = user.email.trim();
      realEmail2Value = user.email.trim(); // üî• CLAVE

      const [local] = realEmailValue.split("@");
      originalEmailLocalLength = local.length;
      emailWasPrefilled = true;

      fieldEmail.value = maskEmail(realEmailValue);
      fieldEmail.disabled = realEmailValue.length > 0 ? true : false;
      fieldDepartament.disabled = false;
      fieldProvince.disabled = false;
      inputcorreo2.disabled = false;
      fieldPhone.innerHTML = `<option value="">Selecciona tu servicio</option>`;

      if (Array.isArray(user.services) && user.services.length > 0) {
        user.services.forEach(({ id, phone }) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = phone;
          fieldPhone.appendChild(option);
        });

        // Seleccionar el primer servicio por defecto
        /*if (user.services.length > 0) {
          fieldPhone.value = user.services[0].id;
          // Verificar si la opci√≥n seleccionada tiene "+" y mostrar/ocultar campos
          setTimeout(() => {
            handlePhoneChange();
          }, 100);
        }*/
      }
      fieldPhone.disabled = false;

      if (validator) {
        validator.revalidateField("#name");
        validator.revalidateField("#email");
        validator.revalidateField("#departament");
        validator.revalidateField("#province");
        validator.revalidateField("#phone");
        validator.revalidateField("#dni");
        validator.revalidateField("#typeDoc");
        validator.revalidateField("#terms");
      }
    };

    const createLocalStorageUser = (
      nameForm,
      emailForm,
      phoneForm,
      typeDocForm,
      dniForm,
      serviceForm,
      provinceForm
    ) => {
      const user = {
        fullName: nameForm,
        email: emailForm,
        phone: phoneForm,
        typeDocument: typeDocForm,
        dni: dniForm,
        serviceId: serviceForm,
        provinceId: provinceForm,
      };
      localStorage.setItem("user", JSON.stringify(user));
    };

    const getLocalStorageUser = () => {
      const user = localStorage.getItem("user");
      return user ? JSON.parse(user) : null;
    };

    const getParameterByUrl = (param: string) => {
      const url = new URL(window.location.href);
      return url.searchParams.get(param);
    };

    const deleteParameterByUrl = (param: string) => {
      const url = new URL(window.location.href);
      url.searchParams.delete(param);
      window.history.replaceState(null, "", url);
    };

    const debounce = (fn, delay = 600) => {
      let timeoutId: number | undefined;
      return (...args: any[]) => {
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        timeoutId = window.setTimeout(() => {
          fn(...args);
        }, delay);
      };
    };

    const handlePreCheckByDni = async () => {
      if (!fieldDni || !fieldTypeDoc) return;
      if (fieldTypeDoc.value === "") {
        fieldTypeDoc.dispatchEvent(new Event("change"));
        return;
      }
      const typeDocument = fieldTypeDoc.value;
      const dniValue = realDniValue.trim();
      if (typeDocument === "DNI") {
        if (dniValue.length !== 8) return;
      } else if (typeDocument === "CEX") {
        if (dniValue.length < 9) return;
      } else if (typeDocument === "PASAPORTE") {
        if (dniValue.length !== 9) return;
      }
      togglePreloadAnimation(true);
      try {
        const { allowed, reason, user } = await preCheck(dniValue);

        if (user) {
          user.verified = true; // üëà FORZAMOS ESTADO CORRECTO
        }
        if (
          (!allowed || !user) &&
          reason !== "Ya est√°s registrado y verificado."
        ) {
          errorFindUser(reason);
          return;
        }
        setValuesForm(user);
        //seteamos los datos del user en el store
        userStore.setState({ user });
      } catch (error) {
        console.error("Error en preCheck desde DNI:", error);
      } finally {
        togglePreloadAnimation(false);
      }
    };
    const sanitizeDniByType = (value: string, type: string) => {
      if (type === "DNI" || type === "PASAPORTE") {
        return value.replace(/\D/g, ""); // solo n√∫meros
      }
      if (type === "CEX") {
        return value.replace(/[^a-zA-Z0-9]/g, ""); // alfanum√©rico
      }
      return "";
    };

    if (fieldDni) {
      const debouncedPreCheck = debounce(handlePreCheckByDni, 600);

      fieldDni.addEventListener("input", (e: InputEvent) => {
        const input = e.target as HTMLInputElement;
        const typeDoc = fieldTypeDoc.value;

        // Quitamos los * visibles
        let visibleValue = input.value.replace(/\*/g, "");

        // üîí Sanitizamos seg√∫n tipo de documento
        visibleValue = sanitizeDniByType(visibleValue, typeDoc);

        // üß† Autofill / pegado / reemplazo masivo
        if (
          e.inputType === "insertFromPaste" ||
          e.inputType === "insertReplacementText" ||
          visibleValue.length > realDniValue.length + 1
        ) {
          realDniValue = visibleValue;
        }

        // üß† Borrado
        else if (e.inputType === "deleteContentBackward") {
          realDniValue = realDniValue.slice(0, -1);
        }

        // üß† Escritura normal
        else if (e.inputType === "insertText" && e.data) {
          const char = sanitizeDniByType(e.data, typeDoc);
          if (!char) return;
          realDniValue += char;
        }

        // üîí Longitud m√°xima
        if (typeDoc === "DNI") {
          realDniValue = realDniValue.slice(0, 8);
        } else if (typeDoc === "PASAPORTE") {
          realDniValue = realDniValue.slice(0, 9);
        } else if (typeDoc === "CEX") {
          realDniValue = realDniValue.slice(0, 20);
        }

        // üé≠ Aplicar m√°scara
        input.value = maskDni(realDniValue);

        // üöÄ Validaci√≥n
        debouncedPreCheck();
      });
      fieldDni.addEventListener("beforeinput", (e: InputEvent) => {
        const typeDoc = fieldTypeDoc.value;
        const data = e.data;

        // Borrado, navegaci√≥n, etc.
        if (!data) return;

        // DNI y PASAPORTE ‚Üí solo n√∫meros
        if (
          (typeDoc === "DNI" || typeDoc === "PASAPORTE") &&
          !/^\d$/.test(data)
        ) {
          e.preventDefault();
        }

        // CEX ‚Üí letras y n√∫meros
        if (typeDoc === "CEX" && !/^[a-zA-Z0-9]$/.test(data)) {
          e.preventDefault();
        }
      });
    }
    fieldTypeDoc.addEventListener("change", () => {
      realDniValue = "";
      fieldDni.value = "";
    });
    if (fieldName) {
      fieldName.addEventListener("input", (e: InputEvent) => {
        const input = e.target as HTMLInputElement;

        // Borrado
        if (e.inputType === "deleteContentBackward") {
          realNameValue = realNameValue.slice(0, -1);
        }

        // Escritura normal
        if (e.inputType === "insertText" && e.data) {
          const char = e.data;

          // Solo letras y espacio
          if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]$/.test(char)) return;

          realNameValue += char;
        }

        // Normalizar espacios m√∫ltiples
        realNameValue = realNameValue.replace(/\s+/g, " ");

        // Aplicar m√°scara visual
        input.value = maskName(realNameValue);
      });
    }

    if (fieldEmail) {
      fieldEmail.addEventListener("input", (e: InputEvent) => {
        const input = e.target as HTMLInputElement;

        if (e.inputType === "deleteContentBackward") {
          realEmailValue = realEmailValue.slice(0, -1);
        }

        if (e.inputType === "insertText" && e.data) {
          const char = e.data;
          if (!/^[a-zA-Z0-9@._-]$/.test(char)) return;
          realEmailValue += char;
        }

        // üßπ Si el usuario borra todo, reci√©n liberamos el masking
        if (realEmailValue.length === 0) {
          emailWasPrefilled = false;
          originalEmailLocalLength = 0;
        }

        input.value = maskEmail(realEmailValue);
      });
    }

    const fieldEmailDos = document.querySelector(
      "#emaildos"
    ) as HTMLInputElement;

    const normalizeEmail = (value: string) => {
      return value
        .trim()
        .replace(/\s+/g, "")
        .replace(/[^a-zA-Z0-9@._-]/g, "");
    };

    const validateEmailDosRealtime = () => {
      const rawValue = fieldEmailDos.value;
      realEmail2Value = normalizeEmail(rawValue);

      // sincroniza visualmente (solo si hubo limpieza)
      if (rawValue !== realEmail2Value) {
        fieldEmailDos.value = realEmail2Value;
      }

      const isValid = isValidEmailBasic(realEmail2Value);

      fieldEmailDos.classList.toggle("success", isValid);
      fieldEmailDos.classList.toggle("error", !isValid);

      if (validator) {
        validator.revalidateField("#emaildos");
      }
    };

    if (fieldEmailDos) {
      // escritura normal, pegar, borrar
      fieldEmailDos.addEventListener("input", validateEmailDosRealtime);

      // autofill / autocomplete del navegador
      fieldEmailDos.addEventListener("change", validateEmailDosRealtime);

      // blur para casos edge
      fieldEmailDos.addEventListener("blur", validateEmailDosRealtime);
    }

    function isValidEmailBasic(value: string): boolean {
      const atIndex = value.indexOf("@");
      const dotIndex = value.lastIndexOf(".");

      return (
        atIndex > 0 && dotIndex > atIndex + 1 && dotIndex < value.length - 1
      );
    }

    if (isValidEmailBasic(realEmail2Value)) {
      fieldEmailDos.classList.remove("error");
      fieldEmailDos.classList.add("success");
    } else {
      fieldEmailDos.classList.remove("success");
      fieldEmailDos.classList.add("error");
    }

    if (realEmail2Value.length === 0) {
      fieldEmailDos.value = "";
    }

    /*
    if (fieldEmailDos) {
      new autoSuggestEmail(fieldEmailDos, {
        domains: [
          "gmail.com",
          "hotmail.com",
          "yahoo.com",
          "icloud.com",
          "outlook.com",
        ],
        priority: [
          "gmail.com",
          "hotmail.com",
          "outlook.com",
          "icloud.com",
          "yahoo.com",
        ],
      });
    }*/

    // Validaci√≥n din√°mica para el campo de documento
    let dniFieldRegistered = false;

    const updateDocumentValidation = (typeDocument) => {
      if (dniFieldRegistered) {
        validator.removeField("#dni");
      }
      if (typeDocument === "DNI") {
        fieldDni.setAttribute("inputmode", "numeric");

        validator.addField("#dni", [
          {
            rule: "required",
            errorMessage: "*Ingresa el n√∫mero de documento.",
          },
          {
            validator: () => realDniValue.length === 8,
            errorMessage: "El DNI debe tener 8 d√≠gitos.",
          },
        ]);
        dniFieldRegistered = true;
      } else if (typeDocument === "CEX") {
        fieldDni.setAttribute("inputmode", "text");
        validator.addField("#dni", [
          {
            rule: "required",
            errorMessage: "*Ingresa el n√∫mero de documento.",
          },
          {
            validator: () => realDniValue.length >= 9,
            errorMessage: "El CEX debe tener m√≠nimo 9 caracteres.",
          },
        ]);
        dniFieldRegistered = true;
      } else if (typeDocument === "PASAPORTE") {
        fieldDni.setAttribute("inputmode", "numeric");
        validator.addField("#dni", [
          {
            rule: "required",
            errorMessage: "*Ingresa el n√∫mero de documento.",
          },
          {
            validator: () => realDniValue.length === 9,
            errorMessage: "El pasaporte debe tener 9 d√≠gitos.",
          },
        ]);
        dniFieldRegistered = true;
      }
    };

    if (fieldTypeDoc) {
      fieldTypeDoc.addEventListener("change", () => {
        if (fieldTypeDoc.value === "") {
          fieldDni.disabled = true;
          return;
        }
        fieldDni.disabled = false;
        updateDocumentValidation(fieldTypeDoc.value);
      });
    }

    if (fieldPhone) {
      fieldPhone.addEventListener("change", () => {
        if (validator) {
          validator.revalidateField("#phone");
          validator.revalidateField("#name");
          validator.revalidateField("#email");
          validator.revalidateField("#dni");
          validator.revalidateField("#typeDoc");
        }
      });
    }

    if (fieldDepartament) {
      const getResponseDepartment = await getDepartament();
      if (getResponseDepartment.success) {
        const departments = getResponseDepartment.data;
        fieldDepartament.innerHTML = `<option value="">Departamento</option>`;
        departments.forEach(({ id, name, isActive }) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          if (isActive) {
            fieldDepartament.appendChild(option);
          }
        });
      }
    }

    fieldDepartament.addEventListener("change", async () => {
      const departmentId = fieldDepartament.value;
      const getResponseProvince = await getProvince(departmentId);
      if (getResponseProvince.success) {
        const provinces = getResponseProvince.data;
        fieldProvince.innerHTML = `<option value="">Provincia</option>`;
        provinces.forEach(({ id, name, isActive }) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          if (isActive) {
            fieldProvince.appendChild(option);
          }
        });
      }
      if (validator) {
        validator.revalidateField("#province");
      }
    });

    const validator = new JustValidate("#form-registro", {
      errorFieldCssClass: "border-red-500",
      errorLabelCssClass: "text-red-500 text-xs mt-1",
      successFieldCssClass: "border-green-500",
      validateBeforeSubmitting: true,
    });

    validator
      .addField("#name", [
        {
          rule: "required",
          errorMessage: "*Ingresa tus nombres y apellidos.",
        },
        {
          validator: () => realNameValue.length >= 3,
          errorMessage: "*Ingresa como m√≠nimo 3 caracteres.",
        },
        {
          validator: () => realNameValue.length <= 60,
          errorMessage: "El nombre no puede superar los 60 caracteres.",
        },
        {
          validator: () => /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(realNameValue),
          errorMessage: "Solo se permiten letras.",
        },
      ])
      .addField("#typeDoc", [
        {
          rule: "required",
          errorMessage: "*Selecciona el tipo de documento.",
        },
      ])
      .addField("#departament", [
        {
          rule: "required",
          errorMessage: "*Selecciona el departamento.",
        },
      ])
      .addField("#province", [
        {
          rule: "required",
          errorMessage: "*Selecciona la provincia.",
        },
      ])
      .addField("#phone", [
        {
          validator: () => {
            if (!fieldPhone) return true;
            // Si est√° deshabilitado, no lo consideramos para la validaci√≥n
            if (fieldPhone.disabled) return true;
            // Cuando est√° habilitado, debe tener un valor distinto de ""
            return fieldPhone.value !== "";
          },
          errorMessage: "*Selecciona tu servicio asociado.",
        },
      ])
      .addField("#email", [
        {
          rule: "required",
          errorMessage: "*Ingresa tu correo electr√≥nico.",
        },
        {
          validator: () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(realEmailValue),
          errorMessage: "Correo electr√≥nico inv√°lido.",
        },
      ])
      .addField("#emaildos", [
        {
          rule: "required",
          errorMessage: "*Ingresa tu correo electr√≥nico.",
        },
        {
          validator: () => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(realEmail2Value),
          errorMessage: "Correo electr√≥nico inv√°lido.",
        },
      ])
      .addField("#terms", [
        {
          rule: "required",
          errorMessage: "*Acepta los t√©rminos y condiciones para participar.",
        },
      ])
      .onValidate(
        ({
          isValid,
          isSubmitted,
          fields,
          errors,
          failedRules,
          failedRulesCount,
        }) => {
          if (isValid) {
            submitBtn.disabled = !isValid;
          } else {
            submitBtn.disabled = !isValid;
          }
        }
      )
      .addField("#comunicacion", [
        {
          rule: "required",
          errorMessage: "*Acepta recibir comunicaci√≥n publicitaria de Claro.",
        },
      ])
      .onSuccess(async (event) => {
        event.preventDefault();
        const dataForm = new FormData(form);
        const fieldPhoneIDForm = dataForm.get("phone") as string;
        const fieldPhoneNameForm =
          fieldPhone.options[fieldPhone.selectedIndex].text;
        const fieldEmailForm = realEmailValue;
        const fieldEmail2Form = realEmail2Value;
        const fieldNameForm = realNameValue;
        const fielDNIForm = realDniValue;
        const fieldProvinceForm = dataForm.get("province") as string;

        // Obtener el tel√©fono adicional si el campo est√° visible
        let telefonoAdicional = "";
        if (inputCasual.style.display !== "none") {
          telefonoAdicional = dataForm.get("telefono") as string;
        }

        const nextStep = Number(submitBtn.dataset.nextStep);
        submitBtn.disabled = true;
        togglePreloadAnimation(true);

        try {
          const { user } = userStore.getState();
          userStore.setState({
            user: {
              ...user,
              serviceId: fieldPhoneIDForm,
              provinceId: fieldProvinceForm,
              telefonoAdicional: telefonoAdicional,
            },
          });
          if (!user) {
            throw new Error(
              "User no est√° definido en el store antes de registerUser"
            );
          }

          const { email, docType, docNumber } = user;
          const registerUserResponse = await registerUser({
            name: fieldNameForm,
            emailConfirm: fieldEmail2Form, // este ser√° el email final
            serviceId: fieldPhoneIDForm,
            docType,
            docNumber: fielDNIForm,
            provinceId: fieldProvinceForm,
            telefono: telefonoAdicional,
          });
          //console.log('registerUserResponse:', registerUserResponse);

          if (registerUserResponse?.success) {
            // ‚úÖ Si canPlay=true, el usuario ya est√° validado y puede jugar inmediatamente
            if (
              registerUserResponse?.canPlay === true &&
              registerUserResponse?.token
            ) {
              console.log("‚úÖ Usuario ya validado - Auto-login activado");

              // Guardar token si el backend lo env√≠a
              if (registerUserResponse.token) {
                localStorage.setItem("authToken", registerUserResponse.token);
              }

              // Actualizar el store con el userId retornado
              const { user } = userStore.getState();
              userStore.setState({
                user: {
                  ...user,
                  id: registerUserResponse.userId,
                  verified: true,
                },
              });

              // Validar si puede girar la ruleta usando el serviceId del formulario
              const userEnabledResponse =
                await validUserEnabled(fieldPhoneIDForm);
              const {
                canSpin,
                remainingPlays,
                playsAllowed,
                playsUsed,
                reason,
              } = userEnabledResponse || {};

              if (canSpin) {
                console.log("Usuario puede jugar, iniciando ruleta");

                // Ocultar formularios y mostrar ruleta
                document
                  .querySelectorAll(".section_hidden")
                  .forEach((section) => section.classList.add("hidden"));
                document
                  .querySelector(".ruletaGanadora")
                  ?.classList.remove("hidden");

                const eventInitRuleta = new CustomEvent("ruleta:enter");
                document.dispatchEvent(eventInitRuleta);

                createLocalStorageUser(
                  fieldNameForm,
                  fieldEmail2Form, // Usar el email confirmado
                  fieldPhoneNameForm,
                  docType,
                  fielDNIForm,
                  fieldPhoneIDForm,
                  fieldProvinceForm
                );

                // Scroll hacia arriba
                window.scrollTo({
                  top: 0,
                  behavior: "smooth",
                });

                togglePreloadAnimation(false);
              } else {
                togglePreloadAnimation(false);
                showCustomModal({
                  title:
                    "Lo sentimos, no puedes participar en estos momentos üëá",
                  html: `<p>${reason}</p>`,
                  iconSrc: icon_no_cumple.src,
                  confirmButtonText: "Entendido",
                  showCloseButton: false,
                  onConfirm: () => {
                    resetForm();
                  },
                });
              }
              return;
            } else {
              // if ((window as any).bannerStepTransition) {
              //   const currentStep = (window as any).bannerStepTransition.getCurrentStep();
              //   (window as any).bannerStepTransition.nextToStep(currentStep, nextStep);
              // }
              createLocalStorageUser(
                fieldNameForm,
                fieldEmailForm,
                fieldPhoneNameForm,
                docType,
                fielDNIForm,
                fieldPhoneIDForm,
                fieldProvinceForm
              );
              togglePreloadAnimation(false);
              showCustomModal({
                title: "¬°Ya casi terminamos!",
                html: `<p>Te hemos enviado un correo para validar tu cuenta.<br><span class="font-amx-bold">Revisa tu bandeja de entrada o spam.</span></p>`,
                iconSrc: icon_no_cumple.src,
                confirmButtonText: "Entendido",
                showCloseButton: false,
                onConfirm: () => {
                  resetForm();
                },
              });
            }
          }
          submitBtn.disabled = false;
          resetForm();
        } catch (error) {
          console.error("Error en onSuccess Paso02:", error);
          togglePreloadAnimation(false);
          showCustomModal({
            iconSrc: icon_no_cumple.src,
            title: "Error en la validaci√≥n",
            html: "",
            confirmButtonText: "Entendido",
            showCloseButton: true,
            onConfirm: () => {
              resetForm();
            },
          });
        }
      });

    if (fieldEmailDos) {
      fieldEmailDos.addEventListener("input", () => {
        if (validator) {
          validator.revalidateField("#emaildos");
        }
      });
    }

    //Crea una funcion para restear el formulario y poder usarlo en onSuccess
    const resetForm = () => {
      form.reset();
      validator.refresh();
      fieldPhone.disabled = true;
      fieldName.disabled = true;
      fieldEmail.disabled = true;
      fieldDni.disabled = true;
      inputTelefono.disabled = true;
      inputCasual.style.display = "none";
      submitBtn.disabled = true;
      realDniValue = "";
      realEmail2Value = "";
      inputcorreo2.disabled = true;
      if (validator) {
        validator.removeField("#telefono");
      }
    };

    restrictInput("#telefono", /[^0-9]/g);

    //Agrega una funci√≥n debounde para el input fieldDNi para cuando el usuario termine de escribir llamar al api preCheck

    // Inicializar autoSuggestEmail para sugerencias de correo
    /*new autoSuggestEmail(fieldEmail, {
      domains: [
        "gmail.com",
        "hotmail.com",
        "yahoo.com",
        "icloud.com",
        "outlook.com",
      ],
      priority: [
        "gmail.com",
        "hotmail.com",
        "outlook.com",
        "icloud.com",
        "yahoo.com",
      ],
    });*/

    handleModal(
      ".openModalTratamiento",
      "#modaltratamiento",
      "#modaltratamiento .section__modals__modal-close",
      "#modaltratamiento .section__modals__modal-footer-close"
    );

    handleModal(
      ".openModalPromociones",
      "#modalpromociones",
      "#modalpromociones .section__modals__modal-close",
      "#modalpromociones .section__modals__modal-footer-close"
    );

    const triggers = document.querySelectorAll(
      ".trigger"
    ) as NodeListOf<HTMLElement>;

    const openTooltip = (e: MouseEvent) => {
      const target = e.target as HTMLElement;
      const tooltip = target.querySelector("[role=tooltip]") as HTMLElement;
      tooltip.classList.add("active");
    };

    const closeTooltip = (e: MouseEvent) => {
      const target = e.target as HTMLElement;
      const tooltip = target.querySelector("[role=tooltip]") as HTMLElement;
      tooltip.classList.remove("active");
    };

    if (triggers) {
      triggers.forEach((trigger) => {
        let tooltip = document.createElement("span");

        tooltip.setAttribute("role", "tooltip");
        tooltip.setAttribute("inert", "true");
        tooltip.textContent = trigger.dataset.tooltip;

        trigger.appendChild(tooltip);

        trigger.addEventListener("mouseenter", openTooltip);
        trigger.addEventListener("mouseleave", closeTooltip);
      });
    }
    const getParameter = getParameterByUrl("code");
    const userLocal = getLocalStorageUser();
    //console.log(getParameter);
    if (getParameter && userLocal) {
      togglePreloadAnimation(true);
      try {
        const verifyCodeResponse = await verifyCode(
          userLocal.email,
          getParameter,
          userLocal.dni
        );
        const { verified, message, status } = verifyCodeResponse || {};
        const verifyMockup = true;
        if (verified) {
          userStore.setState({ user: { ...userLocal, verified: true } });
          const userEnabledResponse = await validUserEnabled(
            userLocal.serviceId
          );
          const { canSpin, remainingPlays, playsAllowed, playsUsed, reason } =
            userEnabledResponse || {};
          const canSpinMockup = true;
          if (canSpin) {
            document
              .querySelectorAll(".section_hidden")
              .forEach((section) => section.classList.add("hidden"));
            document
              .querySelector(".ruletaGanadora")
              .classList.remove("hidden");
            const eventInitRuleta = new CustomEvent("ruleta:enter");
            document.dispatchEvent(eventInitRuleta);
          } else {
            showCustomModal({
              title: "Lo sentimos, no puedes participar en estos momentos üëá",
              html: `<p>${reason}</p>`,
              iconSrc: icon_no_cumple.src,
              confirmButtonText: "Entendido",
              showCloseButton: false,
              onConfirm: () => {
                togglePreloadAnimation(false);
              },
            });
          }
        } else {
          showCustomModal({
            title: "Token inv√°lido y/o expirado",
            html: message || "El token ingresado no es v√°lido",
            iconSrc: icon_no_cumple.src,
            confirmButtonText: "Aceptar",
            showCloseButton: false,
            onConfirm: () => {
              resetForm();
            },
          });
        }
      } catch (error) {
        console.error("Error en verifyCode:", error);
        showCustomModal({
          title: "Error en la validaci√≥n",
          html: "",
          iconSrc: icon_no_cumple.src,
          confirmButtonText: "Entendido",
          showCloseButton: true,
          onConfirm: () => {
            resetForm();
          },
        });
      } finally {
        deleteParameterByUrl("code");
        togglePreloadAnimation(false);
      }
    }

    const getDniByParameter = getParameterByUrl("dnihavas");
    if (getDniByParameter) {
      try {
        const deleteUserByDniResponse =
          await deleteUserByDni(getDniByParameter);
        console.log(deleteUserByDniResponse);
        alert("DNI eliminado correctamente");
        deleteParameterByUrl("dnihavas");
      } catch (error) {
        alert("Error al eliminar el DNI");
      }
    }

    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;

      const btn = target.closest(".btnOpenModal2") as HTMLAnchorElement | null;
      if (!btn) return;

      e.preventDefault();

      const closeModal = document.querySelector(
        ".swal2-close"
      ) as HTMLElement | null;
      closeModal?.click();

      const c20peElement = document.querySelector(
        ".c20pe"
      ) as HTMLElement | null;
      if (!c20peElement) return;

      const yOffset = -80;
      const y =
        c20peElement.getBoundingClientRect().top + window.pageYOffset + yOffset;

      setTimeout(() => {
        window.scrollTo({
          top: y,
          behavior: "smooth",
        });
      }, 1000);

      setTimeout(() => {
        const actBtn = c20peElement.querySelector(
          ".actBtn"
        ) as HTMLElement | null;
        actBtn?.click();
      }, 600);
    });
  });
</script>
